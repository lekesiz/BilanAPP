<div class="container py-4">
    <h1 class="mb-4">Gestion des Utilisateurs</h1>

     {{> messages}}

    {{!-- Filtreleme Formu --}}
     <form method="GET" action="/admin/users" class="mb-3 border rounded p-3 bg-light">
         <div class="row g-2 align-items-end">
             <div class="col-md-4">
                 <label for="userTypeFilter" class="form-label">Filtrer par Type</label>
                <select class="form-select form-select-sm" id="userTypeFilter" name="userType">
                    <option value="">Tous les Types</option>
                    {{#each userTypeOptions}}
                         <option value="{{this}}" {{#ifCond ../selectedUserType '===' this}}selected{{/ifCond}}>{{this}}</option>
                     {{/each}}
                 </select>
             </div>
              <div class="col-md-4">
                 <label for="forfaitTypeFilter" class="form-label">Filtrer par Forfait</label>
                 <select class="form-select form-select-sm" id="forfaitTypeFilter" name="forfaitType">
                     <option value="">Tous les Forfaits</option>
                     <option value="null" {{#ifCond selectedForfaitType '===' 'null'}}selected{{/ifCond}}>-- Aucun --</option>
                     {{#each forfaitOptions}}
                         <option value="{{this}}" {{#ifCond ../selectedForfaitType '===' this}}selected{{/ifCond}}>{{this}}</option>
                     {{/each}}
                 </select>
             </div>
             <div class="col-auto">
                 <button type="submit" class="btn btn-secondary btn-sm">Filtrer</button>
                 <a href="/admin/users" class="btn btn-link btn-sm">Réinitialiser</a>
             </div>
         </div>
     </form>

    <div class="d-flex justify-content-end mb-3">
        <a href="/admin/users/add" class="btn btn-primary">
             <i class="fas fa-plus me-1"></i> Ajouter Utilisateur
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            {{#if users.length}}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0">
                         <thead class="table-light">
                             <tr>
                                 <th>ID</th>
                                 <th>Nom</th>
                                 <th>Email</th>
                                 <th>Type</th>
                                 <th>Forfait</th>
                                 <th>Crédits</th>
                                 <th>Date Création</th>
                                 <th>Actions</th>
                             </tr>
                         </thead>
                         <tbody>
                             {{#each users}}
                                 <tr>
                                     <td>{{id}}</td>
                                     <td>{{lastName}}, {{firstName}}</td>
                                     <td>{{email}}</td>
                                     <td>{{userType}}</td>
                                     <td>
                                         {{#ifCond ../user.id '!==' id}}
                                             <a href="#" data-bs-toggle="modal" data-bs-target="#changeForfaitModal-{{id}}" class="badge bg-info text-decoration-none">
                                                {{#if forfaitType}}{{forfaitType}}{{else}}Aucun{{/if}}
                                             </a>
                                         {{else}}
                                            <span class="badge bg-secondary">{{#if forfaitType}}{{forfaitType}}{{else}}Aucun{{/if}}</span>
                                         {{/ifCond}}
                                     </td>
                                     <td>{{availableCredits}}</td>
                                     <td><small>{{formatDate createdAt}}</small></td>
                                     <td>
                                         <a href="/admin/users/{{id}}/edit" class="btn btn-sm btn-outline-secondary" title="Modifier Utilisateur"><i class="fas fa-edit"></i></a>
                                         {{!-- Kredi Ayarlama Butonu/Modalı --}}
                                         {{#ifCond ../user.id '!==' id}}
                                             <button type="button" class="btn btn-sm btn-outline-warning" title="Ajuster Crédits" 
                                                    data-bs-toggle="modal" data-bs-target="#adjustCreditsModal-{{id}}">
                                                <i class="fas fa-coins"></i>
                                            </button>
                                             <button type="button" class="btn btn-sm btn-outline-danger" title="Supprimer" 
                                                    data-bs-toggle="modal" data-bs-target="#deleteUserModal-{{id}}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                         {{else}}
                                              {{!-- Kendisi için kredi ayarlama ve silme devre dışı --}}
                                               <button class="btn btn-sm btn-outline-warning" disabled><i class="fas fa-coins"></i></button>
                                               <button class="btn btn-sm btn-outline-danger" disabled><i class="fas fa-trash"></i></button>
                                         {{/ifCond}}
                                     </td>
                                 </tr>
                                 {{!-- Silme Onay Modalı --}}
                                 <div class="modal fade" id="deleteUserModal-{{id}}" tabindex="-1" aria-labelledby="deleteUserModalLabel-{{id}}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteUserModalLabel-{{id}}">Confirmer la Suppression</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>{{firstName}} {{lastName}} ({{email}})</strong> ? <br>
                                                <strong class="text-danger">Attention :</strong> Cette action est irréversible et supprimera toutes les données associées à cet utilisateur (profil bénéficiaire éventuel, documents, messages, réponses, logs de crédit, etc.).
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                <form action="/admin/users/{{id}}/delete" method="POST" style="display: inline;">
                                                    <button type="submit" class="btn btn-danger">Supprimer l'Utilisateur</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                 {{!-- Kredi Ayarlama Modalı --}}
                                 <div class="modal fade" id="adjustCreditsModal-{{id}}" tabindex="-1" aria-labelledby="adjustCreditsModalLabel-{{id}}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                             <form action="/admin/users/{{id}}/adjust-credits" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="adjustCreditsModalLabel-{{id}}">Ajuster les Crédits pour {{firstName}} {{lastName}}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>Solde actuel: <strong class="text-primary">{{availableCredits}}</strong> crédits</p>
                                                    <div class="mb-3">
                                                        <label for="amount-{{id}}" class="form-label">Montant à Ajouter/Retirer *</label>
                                                        <input type="number" class="form-control" id="amount-{{id}}" name="amount" placeholder="Ex: 100 ou -50" required>
                                                        <small class="form-text text-muted">Entrez un nombre positif pour ajouter, négatif pour retirer.</small>
                                                    </div>
                                                    <div class="mb-3">
                                                         <label for="reason-{{id}}" class="form-label">Raison de l'ajustement *</label>
                                                         <textarea class="form-control" id="reason-{{id}}" name="reason" rows="2" required></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                    <button type="submit" class="btn btn-warning">Appliquer l'Ajustement</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                 {{!-- Paket Değiştirme Modalı --}}
                                 <div class="modal fade" id="changeForfaitModal-{{id}}" tabindex="-1" aria-labelledby="changeForfaitModalLabel-{{id}}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                             <form action="/admin/users/{{id}}/update-forfait" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="changeForfaitModalLabel-{{id}}">Modifier le Forfait pour {{firstName}} {{lastName}}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>Forfait actuel: <strong class="text-info">{{#if forfaitType}}{{forfaitType}}{{else}}Aucun{{/if}}</strong></p>
                                                    <div class="mb-3">
                                                        <label for="forfaitType-{{id}}" class="form-label">Nouveau Forfait *</label>
                                                        <select class="form-select" id="forfaitType-{{id}}" name="forfaitType">
                                                            <option value="">-- Aucun Forfait --</option> 
                                                            {{#each ../forfaitOptions}}
                                                                <option value="{{this}}" {{#ifCond ../forfaitType '===' this}}selected{{/ifCond}}>{{this}}</option>
                                                            {{/each}}
                                                        </select>
                                                         <small class="form-text text-danger fw-bold">Attention: Changer le forfait réinitialisera les crédits disponibles au montant par défaut.</small>
                                                    </div>
                                                    <p class="small text-muted">Les crédits seront ajustés automatiquement.</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                    <button type="submit" class="btn btn-primary">Changer le Forfait</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                             {{/each}}
                         </tbody>
                     </table>
                 </div>
            {{else}}
                 <p class="text-muted text-center p-4 mb-0">Aucun utilisateur trouvé.</p>
            {{/if}}
        </div>
         {{!-- TODO: Pagination --}}
    </div>
</div> 